{% extends 'base.html' %}
{% block title %}Catálogo{% endblock %}
{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} text-center" role="alert" style="background-color: #e3f2fd; color: #0d47a1; padding: 10px;
border-radius: 5px; margin: 10px 0;">
    {{ message }}
</div>
{% endfor %}
{% endif %}
{% endwith %}
<div class="container overflow-hidden">
    <div class="row gy-4 gy-xxl-5">
        {% for p in productos %}
        <div class="col-12 col-md-6 col-lg-4 d-flex">
            <article class="d-flex">
                <div class="card border border-dark" style="--bs-card-border-radius:
0;">
                    <figure class="card-img-top m-0 overflow-hidden bsb-overlayhover">
                        <a href="#!" data-bs-toggle="modal" data-bstarget="#modal{{p.id_producto}}">
                            <img class="img-fluid bsb-scale bsb-hover-scale-up" loading="lazy" src="{{ url_for('static', filename='uploads/' + p.imagen)
}}" alt="{{ p.nombre_producto }}">
                        </a>
                        <figcaption>
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor"
                                class="bi bi-eye text-white bsb-hover-fadeInLeft" viewBox="0 0 16 16">
                                <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16
8z" />
                                <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z" />
                            </svg>
                            <h4 class="h6 text-white bsb-hover-fadeInRight mt-2">Ver
                                producto</h4>
                        </figcaption>
                    </figure>
                    <div class="card-body bg-white p-4">
                        <h5 class="card-title">{{ p.nombre_producto }}</h5>
                        <p class="card-text text-secondary">{{ p.descripcion }}</p>
                        <p class="card-text"><strong>${{ "{:,.0f}".format(p.precio)
                                }}</strong></p>
                        {% if p.tallas %}
                        <p class="card-text"><strong>Tallas:</strong> {{ p.tallas |
                            join(', ') }}</p>
                        {% else %}
                        <p class="card-text text-muted">Sin tallas disponibles</p>
                        {% endif %}
                        <form action="{{ url_for('agregarCarrito', id=p.id_producto) }}" method="POST">
                            {% if p.tallas %}
                            <label for="talla">Talla</label>
                            <select name="talla" class="form-select mb-2"
                                onchange="actualizarMax(this, '{{ p.id_producto }}')" required>
                                <option value="">Selecciona una talla</option>
                                {% for talla, cantidad in p.tallas.items() %}
                                <option value="{{ talla }}" data-stock="{{ cantidad }}">{{ talla }}
                                    ({{ cantidad }} disponibles)</option>
                                {% endfor %}
                            </select>
                            {% endif %}
                            <label for="cantidad">Cantidad</label>
                            <input type="number" name="cantidad" id="cantidad{{ p.id_producto }}" value="1" min="1"
                                class="form-control mb-2" required>
                            {% if p.cantidad==0 %}
                            <p class="text-danger">Producto agotado</p>
                            {% else %}
                            <p class="text-muted">Disponible: {{ p.cantidad }}</p>
                            {% endif %}
                            <button type="submit"
                                class="{% if p.cantidad==0 %}btnsecondary{% else %}btn-success w-100{% endif %}">Agregar
                                al carrito</button>
                        </form>
                    </div>
                </div>
            </article>
        </div>
        {% endfor %}
    </div>
</div>
{% for p in productos %}
<!-- Modal de producto -->
<div class="modal fade" id="modal{{ p.id_producto }}" tabindex="-1" arialabelledby="modalTitle{{ p.id_producto }}"
    aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-white border-bottom-0">
                <h4 class="modal-title w-100 text-center fw-bold text-dark" id="modalTitle{{ p.id_producto }}">
                    {{ p.nombre_producto }}
                </h4>
                <button type="button" class="btn-close" data-bsdismiss="modal"></button>
            </div>
            <div class="modal-body text-center overflow-auto" style="max-height:
70vh;">
                <img src="{{ url_for('static', filename='uploads/' + p.imagen) }}" alt="{{ p.nombre_producto }}"
                    class="img-fluid rounded mb-3" style="max-height: 300px;">
                <p class="text-muted">{{ p.descripcion }}</p>
                <p class="fs-5 fw-bold text-success">${{ "{:,.0f}".format(p.precio)
                    }}</p>
                {% if p.tallas %}
                <p class="text-muted"><strong>Tallas disponibles:</strong> {{
                    p.tallas | join(', ') }}</p>
                {% else %}
                <p class="text-muted">Sin tallas disponibles</p>
                {% endif %}
                <form action="{{ url_for('agregarCarrito', id=p.id_producto) }}" method="POST" class="mt-3">
                    {% if p.tallas %}
                    <select name="talla" class="form-select mb-2" required>
                        <option value="">Selecciona una talla</option>
                        {% for talla in p.tallas %}
                        <option value="{{ talla }}">{{ talla }}</option>
                        {% endfor %}
                    </select>
                    {% endif %}
                    <input type="number" name="cantidad" value="1" min="1" max="{{
p.cantidad }}" class="form-control mb-2" {% if p.cantidad==0 %}disabled{% endif %}>
                    {% if p.cantidad==0 %}
                    <p class="text-danger">Producto agotado</p>
                    {% else %}
                    <p class="text-muted">Disponible: {{ p.cantidad }}</p>
                    {% endif %}
                    <button type="submit" class="{% if p.cantidad==0 %}btn-secondary{%
else %}btn-success w-100{% endif %}">Agregar al carrito</button>
                </form>
            </div>
            <div class="modal-footer justify-content-center border-top-0">
                <button type="button" class="btn btn-outline-secondary" data-bsdismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
<script>
    function actualizarMax(select, id) {
        const selected = select.options[select.selectedIndex];
        const stock = selected.getAttribute('data-stock');
        const cantidadInput = document.getElementById('cantidad' + id);
        if (stock) {
            cantidadInput.max = stock;
            cantidadInput.placeholder = "Máx: " + stock;
        }
    }
</script>
{% include 'footer_boutique.html' %}
{% endblock %}